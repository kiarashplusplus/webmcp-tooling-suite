name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: |
          npm run build -w @25xcodes/llmfeed-validator
          npm run build -w @25xcodes/llmfeed-signer
          npm run build -w @25xcodes/llmfeed-health-monitor

      - name: Run unit tests
        run: npm run test:run

      - name: Run package tests with coverage
        run: |
          npm test -w @25xcodes/llmfeed-validator -- --coverage
          npm test -w @25xcodes/llmfeed-signer -- --coverage
          npm test -w @25xcodes/llmfeed-health-monitor -- --coverage

      - name: Run integration tests
        run: |
          # Test validator
          node -e "const v = require('./packages/validator/dist/index.js'); console.log('Validator exports:', Object.keys(v))"
          
          # Test signer with async functions
          node -e "
            (async () => {
              const s = require('./packages/signer/dist/index.js');
              console.log('Signer exports:', Object.keys(s));
              
              const { privateKey } = await s.generateKeyPair();
              console.log('Key generated successfully');
              
              const feed = { title: 'Test', items: [] };
              const result = await s.signFeed(feed, privateKey);
              console.log('Sign with base64 key: SUCCESS');
            })();
          "
          
          # Test health-monitor exports
          node -e "
            const h = require('./packages/health-monitor/dist/index.js');
            console.log('Health monitor exports:', Object.keys(h));
            const hasRequired = ['normalizeUrl', 'generateFeedId', 'checkMetaOptOut', 'checkFeedOptOut', 'MemoryStorage', 'generateReport'].every(k => k in h);
            if (!hasRequired) throw new Error('Missing required exports');
            console.log('All required exports present');
          "
          
          echo "âœ… Integration tests passed"

      - name: Typecheck
        run: |
          npm run typecheck -w @25xcodes/llmfeed-health-monitor || true

  lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint || true
